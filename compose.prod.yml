# Production Environment Compose Configuration with Kong
# Features:
# - Production-optimized settings
# - Multiple backend workers
# - No admin tools exposed
# - No test services
# - Kong API Gateway (via compose.kong.yml)

services:
  # Admin tools NOT exposed in production
  adminer:
    restart: always
    # No port exposure in production
    networks:
      - default

  backend:
    restart: always
    networks:
      - kong-network
      - default
    build:
      context: .
      dockerfile: backend/Dockerfile
    command:
      - fastapi
      - run
      - --workers
      - "4"
      - "app/main.py"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/utils/health-check/"]
      interval: 10s
      timeout: 5s
      retries: 5

  frontend:
    restart: always
    networks:
      - kong-network
      - default
    build:
      context: .
      dockerfile: frontend/Dockerfile
      args:
        - VITE_API_URL=https://api.${DOMAIN?Variable not set}
        - NODE_ENV=production

networks:
  kong-network:
    name: ${STACK_NAME:-full-stack-fastapi-project}_kong
    external: false
  default:
    name: ${STACK_NAME:-full-stack-fastapi-project}_default
    external: false
