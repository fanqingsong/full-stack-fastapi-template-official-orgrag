# Development environment override for Airflow
# Usage: docker compose -f docker-compose.yaml -f docker-compose.dev.yml up

version: '3.8'

x-airflow-common:
  &airflow-common
  environment:
    &airflow-common-env
    # Development specific environment variables
    ENVIRONMENT: development
    AIRFLOW_ENV: development
    # Enable debug mode for development
    AIRFLOW__LOGGING__LOGGING_LEVEL: DEBUG
    AIRFLOW__CORE__LOAD_EXAMPLES: 'true'
    AIRFLOW__WEBSERVER__EXPOSE_CONFIG: 'true'

services:
  # Override worker service to add environment file loading
  airflow-worker:
    <<: *airflow-common
    env_file:
      - ${ENV_FILE:-.env}
    environment:
      <<: *airflow-common-env
      # Development specific worker settings
      AIRFLOW__CELERY__WORKER_CONCURRENCY: 2
      AIRFLOW__CELERY__WORKER_LOG_SERVER_PORT: 8793
      # Required to handle warm shutdown of the celery workers properly
      DUMB_INIT_SETSID: "0"

  # Override scheduler for development
  airflow-scheduler:
    <<: *airflow-common
    env_file:
      - ${ENV_FILE:-.env}
    environment:
      <<: *airflow-common-env
      # Development specific scheduler settings
      AIRFLOW__CORE__MAX_DAG_RUN_CONF_SIZE: 10485760
      AIRFLOW__SCHEDULER__JOB_HEARTBEAT_SEC: 5
      AIRFLOW__SCHEDULER__SCHEDULER_HEARTBEAT_SEC: 5

  # Override webserver for development
  airflow-webserver:
    <<: *airflow-common
    env_file:
      - ${ENV_FILE:-.env}
    environment:
      <<: *airflow-common-env
      # Development specific webserver settings
      AIRFLOW__CORE__MAX_DAG_RUN_CONF_SIZE: 10485760
      AIRFLOW__WEBSERVER__EXPOSE_CONFIG: 'true'
      AIRFLOW__WEBSERVER__DEBUG: 'true'

  # Override triggerer for development
  airflow-triggerer:
    <<: *airflow-common
    env_file:
      - ${ENV_FILE:-.env}
    environment:
      <<: *airflow-common-env
      # Development specific triggerer settings
      AIRFLOW__TRIGGERER__DEFAULT_CAPACITY: 1000

  # Override init for development
  airflow-init:
    <<: *airflow-common
    env_file:
      - ${ENV_FILE:-.env}
    environment:
      <<: *airflow-common-env
      # Development specific init settings
      _AIRFLOW_WWW_USER_CREATE: 'true'
      _AIRFLOW_WWW_USER_USERNAME: ${_AIRFLOW_WWW_USER_USERNAME:-airflow}
      _AIRFLOW_WWW_USER_PASSWORD: ${_AIRFLOW_WWW_USER_PASSWORD:-airflow}
      AIRFLOW__CORE__LOAD_EXAMPLES: 'true'
